{% extends "stechec/base.html" %}

{% load humanize static %}
{% load substract %}

{% block title %}Détail du match{% endblock %}
{% block titleh1 %}Détail du match{% endblock %}
{% block head %}
<script type="text/javascript" src="{% static 'js/jquery-1.5.2.min.js' %}"></script>

{% if settings.STECHEC_REPLAY %}
    <script type="text/javascript" src="{% static 'replay/replay.js' %}"></script>
{% endif %}

{% endblock %}

{% block content %}

<dl>
    <dt>ID</dt>
    <dd>{{ match.id }}</dd>

    <dt>Auteur</dt>
    <dd>{{ match.author }}</dd>

    <dt>État</dt>
    <dd>{{ match.get_status_display }}</dd>

    <dt>Date &amp; heure</dt>
    <dd>{{ match.ts|naturalday }} à {{ match.ts|time:"H:i:s" }}</dd>

    {% if match.is_done %}
    <dt>Replay</dt>
    <dd><a href="{% url "match-dump" match.id %}">Télécharger</a></dd>
    {% endif %}
</dl>

<h2>Participants</h2>
<table>
    <thead>
        <tr>
            <th>UID</th>
            <th>ID champion</th>
            <th>Champion</th>
            <th>Score</th>
            <th>Log</th>
        </tr>
    </thead>
    <tbody>
        {% for player in match.matchplayer_set.all %}
        <tr class="{% cycle "row1" "row2" %}">
            <td>{{ player.id|substract:match.matchplayer__id__min }}</td>
            <td>{{ player.champion.id }}</td>
            <td>{{ player.champion }}</td>
            {% if match.is_done %}
            <td>{{ player.score }}</td>
            <td>
                {% if request.user == match.champion.author or request.user.is_staff %}
                <p><a href="#" id="toggle-log-{{ player.id }}">Afficher / cacher le log</a></p>
                <pre id="log-{{ player.id }}">{{ player.log }}</pre>
                {% else %}
                -
                {% endif %}
            </td>
            {% else %}
            <td colspan="2">Non terminé</td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if request.user.is_staff %}
<p><a href="#" id="toggle-serv-log">Afficher / cacher le log serveur</a></p>
<pre id="serv-log">{{ match.log }}</pre>
{% endif %}

<script type="text/javascript">
    {% for player in match.matchplayer_set.all %}
    $("#log-{{ player.id }}").hide();
    $("#toggle-log-{{ player.id }}").click(function() {
        $("#log-{{ player.id }}").slideToggle();
        return false;
    });
    {% endfor %}

    {% if request.user.is_staff %}
    $("#serv-log").hide();
    $("#toggle-serv-log").click(function() {
        $("#serv-log").slideToggle();
        return false;
    });
    {% endif %}
</script>


{% if settings.STECHEC_REPLAY %}
    <div id="replay">
        <canvas id="replay_canvas" width="0" height="0"></canvas>
        <br />
        <aside>
            <div>
                <button class="replay_btn" type="button" onclick="replay_play();">Jouer</button>
                <button class="replay_btn" type="button" onclick="replay_pause();">Pause</button>
                <br /><br />
                <input id="replay_turn" type="range" value="0" min="0" max="0"
                    onchange="replay_update()" />
                Tour : <span id="replay_lbl_turn">0</span>
                <br />
            </div>

            {% for player in match.matchplayer_set.all %}
                <div id="replay_p{{ player.id }}"></div> <br />
            {% endfor %}
        </aside>
    </div>

    <script type="text/javascript">
        replay_init();
    </script>
{% endif %}

{% endblock %}
